#!/bin/bash

# xxxOS Control Script
# Zentrales Steuerungsskript f√ºr Privacy-Tools
# (c) 2025 Martin Pfeffer - MIT License

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOR_SCRIPT="$SCRIPT_DIR/scripts/tor_control.sh"
MAC_SCRIPT="$SCRIPT_DIR/scripts/mac_spoofer.sh"
PRIVACY_SCRIPT="$SCRIPT_DIR/scripts/privacy_enhance.sh"
PROXYCHAINS_SCRIPT="$SCRIPT_DIR/scripts/proxychains_setup.sh"

# Farben f√ºr die Ausgabe
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner anzeigen
show_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            xxxOS v1.0            ‚ïë"
    echo "‚ïë    Privacy & Anonymity Tools     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

# Hilfe anzeigen
show_help() {
    echo "Usage: $0 [command] [options]"
    echo ""
    echo "Commands:"
    echo "  status           - Gesamtstatus aller Privacy-Funktionen"
    echo ""
    echo "  tor <action>     - Tor-Kontrolle"
    echo "    start          - Tor starten"
    echo "    stop           - Tor stoppen"
    echo "    status         - Status anzeigen"
    echo "    proxy-on       - System-Proxy aktivieren"
    echo "    proxy-off      - System-Proxy deaktivieren"
    echo "    full-on        - Tor + Proxy aktivieren"
    echo "    full-off       - Tor + Proxy deaktivieren"
    echo "    test           - Verbindung testen"
    echo ""
    echo "  mac              - MAC-Adresse √§ndern (ben√∂tigt sudo)"
    echo ""
    echo "  privacy          - Vollst√§ndiger Privacy-Modus"
    echo "    on             - MAC √§ndern + Tor aktivieren"
    echo "    off            - Tor deaktivieren"
    echo "    status         - Aktuellen Status anzeigen"
    echo "    ultra          - Ultra-Privacy (alle Funktionen)"
    echo ""
    echo "  enhance <action> - Erweiterte Privacy-Funktionen"
    echo "    dns-clear      - DNS-Cache leeren"
    echo "    hostname       - Hostname randomisieren"
    echo "    browser-clear  - Browser-Daten l√∂schen"
    echo "    firewall       - Firewall aktivieren"
    echo "    dns-privacy    - Privacy-DNS setzen"
    echo "    block-tracking - Tracking blockieren"
    echo "    all            - Alle Funktionen aktivieren"
    echo ""
    echo "  proxychains      - ProxyChains f√ºr Terminal einrichten"
    echo ""
    echo "  help             - Diese Hilfe anzeigen"
    echo ""
    echo "Examples:"
    echo "  $0 status                 # Gesamtstatus anzeigen"
    echo "  $0 tor start              # Tor starten"
    echo "  $0 mac                    # MAC-Adresse √§ndern"
    echo "  $0 privacy on             # Vollst√§ndiger Privacy-Modus"
    echo "  $0 privacy ultra          # Maximum Privacy"
    echo "  $0 enhance dns-clear      # DNS-Cache leeren"
}

# √úberpr√ºfe ob Skripte existieren
check_scripts() {
    if [ ! -f "$TOR_SCRIPT" ]; then
        echo -e "${RED}Fehler: tor_control.sh nicht gefunden in $TOR_SCRIPT${NC}"
        exit 1
    fi
    if [ ! -f "$MAC_SCRIPT" ]; then
        echo -e "${RED}Fehler: mac_spoofer.sh nicht gefunden in $MAC_SCRIPT${NC}"
        exit 1
    fi
    if [ ! -f "$PRIVACY_SCRIPT" ]; then
        echo -e "${RED}Fehler: privacy_enhance.sh nicht gefunden in $PRIVACY_SCRIPT${NC}"
        exit 1
    fi
}

# Tor-Kontrolle
handle_tor() {
    if [ -z "$1" ]; then
        echo -e "${RED}Fehler: Keine Aktion angegeben${NC}"
        echo "Verwende: $0 tor {start|stop|status|proxy-on|proxy-off|full-on|full-off|test}"
        exit 1
    fi
    "$TOR_SCRIPT" "$1"
}

# MAC-Adresse √§ndern
handle_mac() {
    echo -e "${YELLOW}MAC-Adresse wird ge√§ndert (ben√∂tigt sudo)...${NC}"
    sudo "$MAC_SCRIPT"
}

# Privacy-Modus
handle_privacy() {
    case "$1" in
        on)
            show_banner
            echo -e "${GREEN}üîí Aktiviere vollst√§ndigen Privacy-Modus...${NC}"
            echo ""
            
            # MAC-Adresse √§ndern
            echo -e "${BLUE}Schritt 1: MAC-Adresse √§ndern${NC}"
            sudo "$MAC_SCRIPT"
            echo ""
            
            # Tor aktivieren
            echo -e "${BLUE}Schritt 2: Tor aktivieren${NC}"
            "$TOR_SCRIPT" full-on
            echo ""
            
            echo -e "${GREEN}‚úÖ Privacy-Modus aktiviert!${NC}"
            echo ""
            echo "Tipps:"
            echo "- Verwende den Tor Browser f√ºr maximale Anonymit√§t"
            echo "- Oder nutze: proxychains4 <command> f√ºr einzelne Anwendungen"
            echo "- Safari nutzt automatisch den System-Proxy"
            ;;
            
        off)
            show_banner
            echo -e "${YELLOW}üîì Deaktiviere Privacy-Modus...${NC}"
            echo ""
            
            "$TOR_SCRIPT" full-off
            echo ""
            
            echo -e "${GREEN}‚úÖ Privacy-Modus deaktiviert${NC}"
            echo -e "${YELLOW}Hinweis: MAC-Adresse bleibt ge√§ndert bis zum Neustart${NC}"
            ;;
            
        status)
            show_banner
            echo -e "${BLUE}üìä Privacy-Status${NC}"
            echo "=================="
            echo ""
            
            # MAC-Adresse Status
            echo -e "${BLUE}MAC-Adresse:${NC}"
            CURRENT_MAC=$(ifconfig en0 | grep ether | awk '{print $2}')
            echo "Aktuelle MAC: $CURRENT_MAC"
            echo ""
            
            # Tor Status
            "$TOR_SCRIPT" status
            ;;
            
        ultra)
            show_banner
            echo -e "${RED}üõ°Ô∏è  ULTRA PRIVACY MODUS${NC}"
            echo "======================"
            echo ""
            
            # MAC-Adresse √§ndern
            echo -e "${BLUE}Schritt 1: MAC-Adresse √§ndern${NC}"
            sudo "$MAC_SCRIPT"
            echo ""
            
            # Erweiterte Privacy-Funktionen
            echo -e "${BLUE}Schritt 2: Erweiterte Privacy-Funktionen${NC}"
            "$PRIVACY_SCRIPT" all
            echo ""
            
            # Tor aktivieren
            echo -e "${BLUE}Schritt 3: Tor aktivieren${NC}"
            "$TOR_SCRIPT" full-on
            echo ""
            
            # ProxyChains Setup
            echo -e "${BLUE}Schritt 4: ProxyChains konfigurieren${NC}"
            "$PROXYCHAINS_SCRIPT" install
            echo ""
            
            echo -e "${GREEN}‚úÖ ULTRA PRIVACY MODUS AKTIVIERT!${NC}"
            echo ""
            echo -e "${YELLOW}Wichtige Hinweise:${NC}"
            echo "- Firewall ist aktiv mit Stealth-Modus"
            echo "- DNS l√§uft √ºber Cloudflare (1.1.1.1)"
            echo "- Tracking-Domains sind blockiert"
            echo "- Browser-Daten wurden gel√∂scht"
            echo "- Hostname wurde randomisiert"
            echo "- Ortungsdienste sind deaktiviert"
            echo "- ProxyChains ist konfiguriert f√ºr Terminal-Befehle"
            echo ""
            echo -e "${RED}‚ö†Ô∏è  Terminal-Nutzung:${NC}"
            echo "- Normale Befehle: curl ipinfo.io (zeigt echte IP)"
            echo "- √úber Tor: proxychains4 curl ipinfo.io"
            echo "- Oder k√ºrzer: pc curl ipinfo.io"
            echo "- Tor-Shell: torshell (alles √ºber Tor)"
            echo ""
            echo -e "${RED}‚ö†Ô∏è  Browser:${NC}"
            echo "- WebRTC in deinem Browser deaktivieren"
            echo "- Tor Browser f√ºr maximale Anonymit√§t nutzen"
            echo "- JavaScript wenn m√∂glich deaktivieren"
            ;;
            
        *)
            echo -e "${RED}Fehler: Ung√ºltige Option${NC}"
            echo "Verwende: $0 privacy {on|off|status|ultra}"
            exit 1
            ;;
    esac
}

# Erweiterte Privacy-Funktionen
handle_enhance() {
    if [ -z "$1" ]; then
        echo -e "${RED}Fehler: Keine Aktion angegeben${NC}"
        "$PRIVACY_SCRIPT"
        exit 1
    fi
    "$PRIVACY_SCRIPT" "$1"
}

# Gesamtstatus anzeigen
show_overall_status() {
    show_banner
    echo -e "${BLUE}üìä XXXOS PRIVACY STATUS${NC}"
    echo "========================"
    echo ""
    
    # MAC-Adresse
    echo -e "${BLUE}[1] MAC-Adresse${NC}"
    CURRENT_MAC=$(ifconfig en0 | grep ether | awk '{print $2}' 2>/dev/null || echo "Unbekannt")
    echo "    ‚îî‚îÄ Aktuelle MAC: $CURRENT_MAC"
    echo ""
    
    # Tor Status
    echo -e "${BLUE}[2] Tor-Netzwerk${NC}"
    if lsof -i :9050 > /dev/null 2>&1; then
        echo "    ‚îú‚îÄ Service: ‚úÖ L√§uft (Port 9050)"
        # Proxy Status
        local proxy_state=$(networksetup -getsocksfirewallproxy "Wi-Fi" 2>/dev/null | grep "Enabled: Yes")
        if [ -n "$proxy_state" ]; then
            echo "    ‚îú‚îÄ System-Proxy: ‚úÖ Aktiviert"
        else
            echo "    ‚îú‚îÄ System-Proxy: ‚ùå Deaktiviert"
        fi
        # IP-Check
        local is_tor=$(curl -s --connect-timeout 3 https://check.torproject.org/api/ip 2>/dev/null | jq -r '.IsTor' 2>/dev/null || echo "false")
        if [ "$is_tor" = "true" ]; then
            echo "    ‚îî‚îÄ Verbindung: ‚úÖ √úber Tor"
        else
            echo "    ‚îî‚îÄ Verbindung: ‚ö†Ô∏è  Direkt (nicht √ºber Tor)"
        fi
    else
        echo "    ‚îî‚îÄ Service: ‚ùå Gestoppt"
    fi
    echo ""
    
    # Firewall Status
    echo -e "${BLUE}[3] Firewall${NC}"
    local fw_status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null | grep "enabled")
    if [ -n "$fw_status" ]; then
        echo "    ‚îú‚îÄ Status: ‚úÖ Aktiviert"
        local stealth=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getstealthmode 2>/dev/null | grep "enabled")
        if [ -n "$stealth" ]; then
            echo "    ‚îî‚îÄ Stealth-Modus: ‚úÖ Aktiviert"
        else
            echo "    ‚îî‚îÄ Stealth-Modus: ‚ùå Deaktiviert"
        fi
    else
        echo "    ‚îî‚îÄ Status: ‚ùå Deaktiviert"
    fi
    echo ""
    
    # DNS Status
    echo -e "${BLUE}[4] DNS-Konfiguration${NC}"
    local dns_servers=$(networksetup -getdnsservers "Wi-Fi" 2>/dev/null | head -2 | tr '\n' ' ')
    if [[ "$dns_servers" == *"1.1.1.1"* ]]; then
        echo "    ‚îî‚îÄ Server: ‚úÖ Cloudflare (Privacy)"
    elif [[ "$dns_servers" == *"9.9.9.9"* ]]; then
        echo "    ‚îî‚îÄ Server: ‚úÖ Quad9 (Privacy)"
    elif [[ "$dns_servers" == *"There aren't any"* ]]; then
        echo "    ‚îî‚îÄ Server: ‚ö†Ô∏è  Standard (DHCP)"
    else
        echo "    ‚îî‚îÄ Server: $dns_servers"
    fi
    echo ""
    
    # Hostname
    echo -e "${BLUE}[5] System-Identifikation${NC}"
    local hostname=$(scutil --get ComputerName 2>/dev/null || echo "Unbekannt")
    echo "    ‚îî‚îÄ Hostname: $hostname"
    echo ""
    
    # Tracking-Schutz
    echo -e "${BLUE}[6] Tracking-Schutz${NC}"
    if grep -q "# xxxOS Privacy Block List" /etc/hosts 2>/dev/null; then
        local blocked_count=$(grep -c "^0.0.0.0" /etc/hosts 2>/dev/null || echo "0")
        echo "    ‚îî‚îÄ Hosts-Datei: ‚úÖ Modifiziert ($blocked_count Domains blockiert)"
    else
        echo "    ‚îî‚îÄ Hosts-Datei: ‚ùå Standard"
    fi
    echo ""
    
    # Ortungsdienste
    echo -e "${BLUE}[7] Ortungsdienste${NC}"
    if pgrep -x "locationd" > /dev/null 2>&1; then
        echo "    ‚îî‚îÄ Status: ‚ö†Ô∏è  Aktiviert"
    else
        echo "    ‚îî‚îÄ Status: ‚úÖ Deaktiviert"
    fi
    echo ""
    
    # Privacy-Level Einsch√§tzung
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    local privacy_score=0
    
    # Punkte berechnen
    [ "$is_tor" = "true" ] && privacy_score=$((privacy_score + 3))
    [ -n "$fw_status" ] && privacy_score=$((privacy_score + 2))
    [[ "$dns_servers" == *"1.1.1.1"* || "$dns_servers" == *"9.9.9.9"* ]] && privacy_score=$((privacy_score + 2))
    grep -q "# xxxOS Privacy Block List" /etc/hosts 2>/dev/null && privacy_score=$((privacy_score + 2))
    ! pgrep -x "locationd" > /dev/null 2>&1 && privacy_score=$((privacy_score + 1))
    
    echo -n "Privacy-Level: "
    if [ $privacy_score -ge 8 ]; then
        echo -e "${GREEN}‚¨õ‚¨õ‚¨õ‚¨õ‚¨õ MAXIMUM${NC}"
    elif [ $privacy_score -ge 6 ]; then
        echo -e "${GREEN}‚¨õ‚¨õ‚¨õ‚¨õ‚¨ú HOCH${NC}"
    elif [ $privacy_score -ge 4 ]; then
        echo -e "${YELLOW}‚¨õ‚¨õ‚¨õ‚¨ú‚¨ú MITTEL${NC}"
    elif [ $privacy_score -ge 2 ]; then
        echo -e "${YELLOW}‚¨õ‚¨õ‚¨ú‚¨ú‚¨ú NIEDRIG${NC}"
    else
        echo -e "${RED}‚¨õ‚¨ú‚¨ú‚¨ú‚¨ú MINIMAL${NC}"
    fi
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
}

# Hauptprogramm
main() {
    check_scripts
    
    if [ $# -eq 0 ]; then
        show_banner
        show_help
        exit 0
    fi
    
    case "$1" in
        status)
            show_overall_status
            ;;
        tor)
            handle_tor "$2"
            ;;
        mac)
            handle_mac
            ;;
        privacy)
            handle_privacy "$2"
            ;;
        enhance)
            handle_enhance "$2"
            ;;
        proxychains)
            "$PROXYCHAINS_SCRIPT" install
            ;;
        help|-h|--help)
            show_banner
            show_help
            ;;
        *)
            echo -e "${RED}Fehler: Unbekannter Befehl '$1'${NC}"
            echo "Verwende: $0 help f√ºr Hilfe"
            exit 1
            ;;
    esac
}

# Skript ausf√ºhren
main "$@"